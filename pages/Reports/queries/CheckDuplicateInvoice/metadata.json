{
  "gitSyncId": "6849bf18ee95b36a89c2b3cd_12313b82-0847-40eb-85cc-bf28e4540634",
  "id": "Reports_CheckDuplicateInvoice",
  "pluginId": "mssql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- CheckDuplicateInvoice\nDECLARE \n  @InvoiceNumber NVARCHAR(50) = '{{ invoiceFiled.text.trim() }}',\n  @InvoiceDate NVARCHAR(50) = '{{ moment().format(\"YYYY-MM-DD HH:mm\") }}',\n  @InvoiceMatterID INT = {{ MattersMultiSelect.selectedOptionValues[0] || 0 }},\n  @InvoiceClientID INT = {{ ClientsMultiSelect.selectedOptionValues[0] || 0 }},\n  @TimesheetID NVARCHAR(4000) = '{{ invoiceTable.tableData.map(row => row.ID).join(\",\") }}';\n\n-- Temp table to hold timesheet IDs\nIF OBJECT_ID('tempdb..#TimeSheetIDTbl') IS NOT NULL DROP TABLE #TimeSheetIDTbl;\n\nCREATE TABLE #TimeSheetIDTbl (value NVARCHAR(50));\n\nINSERT INTO #TimeSheetIDTbl\nSELECT value FROM dbo.fn_Split(@TimesheetID, ',') WHERE value <> '';\n\n-- Check for duplicates\nIF EXISTS (\n\tSELECT 1 \n\tFROM Invoices i\n\tJOIN InvoiceDetails d ON d.InvoiceDetails_Invoices_ID = i.ID\n\tWHERE i.Invoices_Number = @InvoiceNumber\n\t  AND i.Invoices_Clients_ID = @InvoiceClientID\n\t  AND i.Invoices_Matter_ID = @InvoiceMatterID\n\t  AND CAST(i.Invoices_Date AS DATE) = CAST(@InvoiceDate AS DATE)\n\t  AND EXISTS (\n\t\t  SELECT 1 FROM #TimeSheetIDTbl ts\n\t\t  WHERE CAST(ts.value AS INT) = d.InvoiceDetails_TimeSheet_ID\n\t  )\n)\n\tSELECT 1 AS IsDuplicate;\nELSE\n\tSELECT 0 AS IsDuplicate;\n\nDROP TABLE #TimeSheetIDTbl;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Law Project DB",
      "isAutoGenerated": false,
      "name": "Law Project DB",
      "pluginId": "mssql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "CheckDuplicateInvoice",
    "pageId": "Reports",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}